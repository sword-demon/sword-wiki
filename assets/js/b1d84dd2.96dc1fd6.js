"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9046],{4137:(e,n,r)=>{r.d(n,{Zo:()=>m,kt:()=>u});var t=r(7294);function o(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){o(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function c(e,n){if(null==e)return{};var r,t,o=function(e,n){if(null==e)return{};var r,t,o={},a=Object.keys(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||(o[r]=e[r]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var l=t.createContext({}),s=function(e){var n=t.useContext(l),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},m=function(e){var n=s(e.components);return t.createElement(l.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},g=t.forwardRef((function(e,n){var r=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,m=c(e,["components","mdxType","originalType","parentName"]),g=s(r),u=o,d=g["".concat(l,".").concat(u)]||g[u]||p[u]||a;return r?t.createElement(d,i(i({ref:n},m),{},{components:r})):t.createElement(d,i({ref:n},m))}));function u(e,n){var r=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=r.length,i=new Array(a);i[0]=g;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c.mdxType="string"==typeof e?e:o,i[1]=c;for(var s=2;s<a;s++)i[s]=r[s];return t.createElement.apply(null,i)}return t.createElement.apply(null,r)}g.displayName="MDXCreateElement"},6241:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>c,toc:()=>s});var t=r(7462),o=(r(7294),r(4137));const a={id:"go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",title:"go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",sidebar_position:3,data:"2021\u5e7411\u670815\u65e5"},i="go-micro v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",c={unversionedId:"Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",id:"Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",title:"go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",description:"jaeger \u539f\u7406",source:"@site/wiki/dev/Go/go-micro-v3/3.go-micro-v3\u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a.md",sourceDirName:"Go/go-micro-v3",slug:"/Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",permalink:"/sword-wiki/dev/Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",draft:!1,tags:[],version:"current",lastUpdatedBy:"wxvirus",lastUpdatedAt:1668446148,formattedLastUpdatedAt:"2022\u5e7411\u670814\u65e5",sidebarPosition:3,frontMatter:{id:"go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",title:"go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",sidebar_position:3,data:"2021\u5e7411\u670815\u65e5"},sidebar:"tutorialSidebar",previous:{title:"go-micro-v3 \u6846\u67b6\u6574\u4f53\u4ecb\u7ecd",permalink:"/sword-wiki/dev/Go/go-micro-v3/go-micro-v3 \u6846\u67b6\u6574\u4f53\u4ecb\u7ecd"},next:{title:"go-micro-v3 \u6dfb\u52a0\u7194\u65ad",permalink:"/sword-wiki/dev/Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u7194\u65ad"}},l={},s=[{value:"jaeger \u539f\u7406",id:"jaeger-\u539f\u7406",level:2},{value:"docker-compose\u5b89\u88c5jaeger",id:"docker-compose\u5b89\u88c5jaeger",level:2},{value:"common\u7edf\u4e00\u6a21\u5757\u6dfb\u52a0jaeger",id:"common\u7edf\u4e00\u6a21\u5757\u6dfb\u52a0jaeger",level:2},{value:"base\u57fa\u7840\u670d\u52a1\u4ee3\u7801\u6dfb\u52a0jaeger",id:"base\u57fa\u7840\u670d\u52a1\u4ee3\u7801\u6dfb\u52a0jaeger",level:2}],m={toc:s};function p(e){let{components:n,...r}=e;return(0,o.kt)("wrapper",(0,t.Z)({},m,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"go-micro-v3-\u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a"},"go-micro v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a"),(0,o.kt)("h2",{id:"jaeger-\u539f\u7406"},"jaeger \u539f\u7406"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"  \u5f15\u7528\uff1a")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://blog.csdn.net/sD7O95O/article/details/115534715"},"https://blog.csdn.net/sD7O95O/article/details/115534715"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://cloud.tencent.com/developer/article/1160850"},"https://cloud.tencent.com/developer/article/1160850"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"\u6587\u6863\u5730\u5740\uff1a",(0,o.kt)("a",{parentName:"p",href:"https://www.jaegertracing.io/docs/1.18/"},"https://www.jaegertracing.io/docs/1.18/"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"github\u5730\u5740\uff1a",(0,o.kt)("a",{parentName:"p",href:"https://github.com/jaegertracing/jaeger"},"https://github.com/jaegertracing/jaeger"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"\u5b98\u7f51\u5730\u5740\uff1a",(0,o.kt)("a",{parentName:"p",href:"https://www.jaegertracing.io/"},"https://www.jaegertracing.io/")))),(0,o.kt)("h2",{id:"docker-compose\u5b89\u88c5jaeger"},"docker-compose\u5b89\u88c5jaeger"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'version: \'3\'\nservices:\n  # \u6ce8\u518c\u4e2d\u5fc3\u96c6\u7fa4\u7248\u672c\u8bbe\u7f6e\n  consul1:\n    image: cap1573/consul\n    container_name: node1\n    # \u4ee5 server \u6a21\u5f0f\u542f\u52a8\n    command: agent -server -bootstrap-expect=3 -node=node1 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1\n  consul2:\n    image: cap1573/consul\n    container_name: node2\n    # \u4ee5 server \u6a21\u5f0f\u542f\u52a8\n    command: agent -server -retry-join=node1 -bootstrap-expect=3 -node=node2 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1\n    depends_on:\n      # \u4f9d\u8d56consul1\u542f\u52a8\u597d\u4e4b\u540e\n      - consul1\n  consul3:\n    image: cap1573/consul\n    container_name: node3\n    # \u4ee5 server \u6a21\u5f0f\u542f\u52a8\n    command: agent -server -retry-join=node1 -bootstrap-expect=3 -node=node3 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1\n    depends_on:\n      # \u4f9d\u8d56consul1\u542f\u52a8\u597d\u4e4b\u540e\n      - consul1\n  # \u6dfb\u52a0\u5bf9\u5916\u66b4\u9732\u7684\u8282\u70b9 \u542f\u52a8\u63a7\u5236\u9762\u677f\n  consul4:\n    image: consul\n    container_name: node4\n    command: agent -retry-join=node1 -node=node4 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1 -ui\n    ports:\n      - 8500:8500\n    depends_on:\n      - consul2\n      - consul3\n  # \u6dfb\u52a0\u6570\u636e\u5e93\n  paas-mysql:\n    image: cap1573/mysql:5.6\n    environment:\n      MYSQL_ROOT_PASSWORD: 123456\n      container_name: paas-mysql\n    # \u6211\u4eec\u8fd9\u91cc\u6362\u4e2a\u7aef\u53e3\uff0c\u672c\u5730\u5df2\u7ecf\u67093306\u4e86\n    ports:\n      - "3308:3306"\n    # \u9700\u8981\u5c06\u91cd\u8981\u7684\u6570\u636e\u6302\u76d8\n    volumes:\n      - ./mysql:/var/lib/mysql\n  # \u6dfb\u52a0jaeger \u670d\u52a1\n  jaeger:\n    image: cap1573/jaeger\n    ports:\n      - "6831:6831/udp"\n      - "16686:16686"\n')),(0,o.kt)("p",null,"\u6dfb\u52a0\u597d",(0,o.kt)("inlineCode",{parentName:"p"},"jaeger"),"\u914d\u7f6e\u540e\uff0c\u9700\u8981\u91cd\u542f\u4e00\u4e0b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up\n")),(0,o.kt)("p",null,"\u542f\u52a8\u5b8c\u6210\u4e4b\u540e\u53ef\u4ee5\u5230\u6d4f\u89c8\u5668\u53bb\u8bbf\u95ee\uff1a",(0,o.kt)("a",{parentName:"p",href:"http://127.0.0.1:16686/"},"http://127.0.0.1:16686/")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://virusoss.oss-cn-shanghai.aliyuncs.com/images/image-20221106113229463.png",alt:"image-20221106113229463"})),(0,o.kt)("h2",{id:"common\u7edf\u4e00\u6a21\u5757\u6dfb\u52a0jaeger"},"common\u7edf\u4e00\u6a21\u5757\u6dfb\u52a0jaeger"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"jaeger.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package common\n\nimport (\n    "github.com/opentracing/opentracing-go"\n    "github.com/uber/jaeger-client-go"\n    jaegercfg "github.com/uber/jaeger-client-go/config"\n    "io"\n    "time"\n)\n\n// NewTracer \u521b\u5efajaeger\u94fe\u8def\u8ffd\u8e2a\u5b9e\u4f8b\nfunc NewTracer(serviceName string, addr string) (opentracing.Tracer, io.Closer, error) {\n    cfg := &jaegercfg.Configuration{\n        ServiceName: serviceName,\n        Sampler: &jaegercfg.SamplerConfig{\n            Type:  jaeger.SamplerTypeConst,\n            Param: 1,\n        },\n        Reporter: &jaegercfg.ReporterConfig{\n            LogSpans:            true,\n            BufferFlushInterval: 1 * time.Second,\n            LocalAgentHostPort:  addr,\n        },\n    }\n    tracer, closer, err := cfg.NewTracer()\n    return tracer, closer, err\n}\n\n')),(0,o.kt)("h2",{id:"base\u57fa\u7840\u670d\u52a1\u4ee3\u7801\u6dfb\u52a0jaeger"},"base\u57fa\u7840\u670d\u52a1\u4ee3\u7801\u6dfb\u52a0jaeger"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"go get github.com/opentracing/opentracing-go\ngo get github.com/asim/go-micro/plugins/wrapper/trace/opentracing/v3\n")),(0,o.kt)("p",null,"\u8fd8\u5f97\u62c9\u53d6\u4e00\u4e0b\u4e0a\u9762\u66f4\u65b0\u540e\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"common"),"\u6a21\u5757\uff0c\u4e0d\u7136\u65e0\u6cd5\u4f7f\u7528",(0,o.kt)("inlineCode",{parentName:"p"},"common"),"\u6a21\u5757\u4e2d\u7684",(0,o.kt)("inlineCode",{parentName:"p"},"NewTracer"),"\u65b9\u6cd5\u3002"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"main.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport (\n    "fmt"\n    "github.com/wujie/base/handler"\n    base "github.com/wujie/base/proto/base"\n    "github.com/wujie/common"\n    "github.com/asim/go-micro/v3/registry"\n    "github.com/jinzhu/gorm"\n    "github.com/opentracing/opentracing-go"\n    //"github.com/afex/hystrix-go/hystrix"\n    "github.com/asim/go-micro/plugins/registry/consul/v3"\n    opentracing2 "github.com/asim/go-micro/plugins/wrapper/trace/opentracing/v3"\n    "github.com/asim/go-micro/v3"\n    _ "github.com/jinzhu/gorm/dialects/mysql"\n)\n\nfunc main() {\n    //\u9700\u8981\u672c\u5730\u542f\u52a8\uff0cmysql\uff0cconsul\u4e2d\u95f4\u4ef6\u670d\u52a1\n    //1.\u6ce8\u518c\u4e2d\u5fc3\n    //consul := consul.NewRegistry(func(options *registry.Options) {\n    //  options.Addrs = []string{\n    //      consulHost + ":" + strconv.FormatInt(consulPort, 10),\n    //  }\n    //})\n    consul := consul.NewRegistry(func(options *registry.Options) {\n        options.Addrs = []string{\n            "localhost:8500",\n        }\n    })\n    //2.\u914d\u7f6e\u4e2d\u5fc3\uff0c\u5b58\u653e\u7ecf\u5e38\u53d8\u52a8\u7684\u53d8\u91cf\n    consulConfig, err := common.GetConsulConfig("localhost", consulPort, "/micro/config")\n    if err != nil {\n        //common.Error(err)\n        fmt.Println(err)\n    }\n    fmt.Println(consulConfig)\n    //3.\u4f7f\u7528\u914d\u7f6e\u4e2d\u5fc3\u8fde\u63a5 mysql\n    // \u8fd9\u91cc\u7684path\u662f\u76f8\u5bf9\u4e8e /micro/config \u76ee\u5f55\u8def\u5f84\n    mysqlInfo := common.GetMysqlFromConsul(consulConfig, "mysql")\n    //\u521d\u59cb\u5316\u6570\u636e\u5e93\n    fmt.Println(mysqlInfo)\n    db, err := gorm.Open("mysql", mysqlInfo.User+":"+mysqlInfo.Pwd+"@("+mysqlInfo.Host+":3308)/"+mysqlInfo.Database+"?charset=utf8&parseTime=True&loc=Local")\n    if err != nil {\n        //\u547d\u4ee4\u884c\u8f93\u51fa\u4e0b\uff0c\u65b9\u4fbf\u67e5\u770b\u9519\u8bef\n        fmt.Println(err)\n        common.Fatal(err)\n        fmt.Println("mysql\u8fde\u63a5\u5931\u8d25")\n    }\n    fmt.Println("mysql\u8fde\u63a5\u6210\u529f")\n    defer db.Close()\n    //\u7981\u6b62\u590d\u8868\n    db.SingularTable(true)\n\n    //4.\u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a\n    //t, io, err := common.NewTracer("go.micro.service.base", tracerHost+":"+strconv.Itoa(tracerPort))\n    t, io, err := common.NewTracer("base", "localhost:6831")\n    if err != nil {\n        //common.Error(err)\n        fmt.Println(err)\n    }\n    defer io.Close()\n    // \u8bbe\u7f6e\u5168\u5c40\u53d8\u91cf\n    opentracing.SetGlobalTracer(t)\n\n    // \u6dfb\u52a0\u670d\u52a1\n    service := micro.NewService(\n        micro.Name("base-wj"),\n        micro.Version("latest"),\n        // \u6dfb\u52a0\u6ce8\u518c\u4e2d\u5fc3\n        micro.Registry(consul),\n        // \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a\n        micro.WrapHandler(opentracing2.NewHandlerWrapper(opentracing.GlobalTracer())),\n    )\n\n    service.Init()\n\n    base.RegisterBaseHandler(service.Server(), new(handler.BaseHandler))\n\n    // \u542f\u52a8\u670d\u52a1\n    if err := service.Run(); err != nil {\n        //\u8f93\u51fa\u542f\u52a8\u5931\u8d25\u4fe1\u606f\n        common.Fatal(err)\n    }\n}\n')),(0,o.kt)("p",null,"\u518d\u6b21\u8fdb\u884c\u8fd0\u884c\u6d4b\u8bd5\u5373\u53ef\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# \u8fd0\u884c base \u670d\u52a1\ngo run main.go\n\nconfig\n&{127.0.0.1 root 123456 paas }\nmysql\u8fde\u63a5\u6210\u529f\n2022-11-06 11:44:44  file=v3@v3.7.0/service.go:206 level=info Starting [service] base-wj\n2022-11-06 11:44:44  file=server/rpc_server.go:820 level=info Transport [http] Listening on [::]:57588\n2022-11-06 11:44:44  file=server/rpc_server.go:840 level=info Broker [http] Connected to 127.0.0.1:57589\n2022-11-06 11:44:44  file=server/rpc_server.go:654 level=info Registry [consul] Registering node: base-wj-f63478c8-3e87-45d9-92fb-0e6c1dac2959\n")))}p.isMDXComponent=!0}}]);
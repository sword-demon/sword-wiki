"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3168],{4137:(n,e,r)=>{r.d(e,{Zo:()=>m,kt:()=>g});var t=r(7294);function o(n,e,r){return e in n?Object.defineProperty(n,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[e]=r,n}function i(n,e){var r=Object.keys(n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(n);e&&(t=t.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.push.apply(r,t)}return r}function a(n){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?i(Object(r),!0).forEach((function(e){o(n,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(r,e))}))}return n}function c(n,e){if(null==n)return{};var r,t,o=function(n,e){if(null==n)return{};var r,t,o={},i=Object.keys(n);for(t=0;t<i.length;t++)r=i[t],e.indexOf(r)>=0||(o[r]=n[r]);return o}(n,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(t=0;t<i.length;t++)r=i[t],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(n,r)&&(o[r]=n[r])}return o}var s=t.createContext({}),l=function(n){var e=t.useContext(s),r=e;return n&&(r="function"==typeof n?n(e):a(a({},e),n)),r},m=function(n){var e=l(n.components);return t.createElement(s.Provider,{value:e},n.children)},p={inlineCode:"code",wrapper:function(n){var e=n.children;return t.createElement(t.Fragment,{},e)}},u=t.forwardRef((function(n,e){var r=n.components,o=n.mdxType,i=n.originalType,s=n.parentName,m=c(n,["components","mdxType","originalType","parentName"]),u=l(r),g=o,d=u["".concat(s,".").concat(g)]||u[g]||p[g]||i;return r?t.createElement(d,a(a({ref:e},m),{},{components:r})):t.createElement(d,a({ref:e},m))}));function g(n,e){var r=arguments,o=e&&e.mdxType;if("string"==typeof n||o){var i=r.length,a=new Array(i);a[0]=u;var c={};for(var s in e)hasOwnProperty.call(e,s)&&(c[s]=e[s]);c.originalType=n,c.mdxType="string"==typeof n?n:o,a[1]=c;for(var l=2;l<i;l++)a[l]=r[l];return t.createElement.apply(null,a)}return t.createElement.apply(null,r)}u.displayName="MDXCreateElement"},3659:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>s,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var t=r(7462),o=(r(7294),r(4137));const i={id:"go-micro-v3 \u6dfb\u52a0\u7194\u65ad",title:"go-micro-v3 \u6dfb\u52a0\u7194\u65ad",sidebar_position:4,data:"2021\u5e7411\u670815\u65e5"},a="go-micro v3\u6dfb\u52a0\u7194\u65ad",c={unversionedId:"Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u7194\u65ad",id:"Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u7194\u65ad",title:"go-micro-v3 \u6dfb\u52a0\u7194\u65ad",description:"docker-compose\u6dfb\u52a0\u7194\u65ad\u670d\u52a1",source:"@site/wiki/dev/Go/go-micro-v3/4.go-micro-v3\u6dfb\u52a0\u7194\u65ad\u5668.md",sourceDirName:"Go/go-micro-v3",slug:"/Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u7194\u65ad",permalink:"/sword-wiki/dev/Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u7194\u65ad",draft:!1,tags:[],version:"current",lastUpdatedBy:"wxvirus",lastUpdatedAt:1668446148,formattedLastUpdatedAt:"2022\u5e7411\u670814\u65e5",sidebarPosition:4,frontMatter:{id:"go-micro-v3 \u6dfb\u52a0\u7194\u65ad",title:"go-micro-v3 \u6dfb\u52a0\u7194\u65ad",sidebar_position:4,data:"2021\u5e7411\u670815\u65e5"},sidebar:"tutorialSidebar",previous:{title:"go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a",permalink:"/sword-wiki/dev/Go/go-micro-v3/go-micro-v3 \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a"},next:{title:"go\u5bf9\u63a5websocket",permalink:"/sword-wiki/dev/category/go\u5bf9\u63a5websocket"}},s={},l=[{value:"docker-compose\u6dfb\u52a0\u7194\u65ad\u670d\u52a1",id:"docker-compose\u6dfb\u52a0\u7194\u65ad\u670d\u52a1",level:2},{value:"base\u670d\u52a1\u6dfb\u52a0\u7194\u65ad\u5668\u670d\u52a1",id:"base\u670d\u52a1\u6dfb\u52a0\u7194\u65ad\u5668\u670d\u52a1",level:2}],m={toc:l};function p(n){let{components:e,...r}=n;return(0,o.kt)("wrapper",(0,t.Z)({},m,r,{components:e,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"go-micro-v3\u6dfb\u52a0\u7194\u65ad"},"go-micro v3\u6dfb\u52a0\u7194\u65ad"),(0,o.kt)("h2",{id:"docker-compose\u6dfb\u52a0\u7194\u65ad\u670d\u52a1"},"docker-compose\u6dfb\u52a0\u7194\u65ad\u670d\u52a1"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'version: \'3\'\nservices:\n  # \u6ce8\u518c\u4e2d\u5fc3\u96c6\u7fa4\u7248\u672c\u8bbe\u7f6e\n  consul1:\n    image: cap1573/consul\n    container_name: node1\n    # \u4ee5 server \u6a21\u5f0f\u542f\u52a8\n    command: agent -server -bootstrap-expect=3 -node=node1 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1\n  consul2:\n    image: cap1573/consul\n    container_name: node2\n    # \u4ee5 server \u6a21\u5f0f\u542f\u52a8\n    command: agent -server -retry-join=node1 -bootstrap-expect=3 -node=node2 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1\n    depends_on:\n      # \u4f9d\u8d56consul1\u542f\u52a8\u597d\u4e4b\u540e\n      - consul1\n  consul3:\n    image: cap1573/consul\n    container_name: node3\n    # \u4ee5 server \u6a21\u5f0f\u542f\u52a8\n    command: agent -server -retry-join=node1 -bootstrap-expect=3 -node=node3 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1\n    depends_on:\n      # \u4f9d\u8d56consul1\u542f\u52a8\u597d\u4e4b\u540e\n      - consul1\n  # \u6dfb\u52a0\u5bf9\u5916\u66b4\u9732\u7684\u8282\u70b9 \u542f\u52a8\u63a7\u5236\u9762\u677f\n  consul4:\n    image: consul\n    container_name: node4\n    command: agent -retry-join=node1 -node=node4 -bind=0.0.0.0 -client=0.0.0.0 -datacenter=dc1 -ui\n    ports:\n      - 8500:8500\n    depends_on:\n      - consul2\n      - consul3\n  # \u6dfb\u52a0\u6570\u636e\u5e93\n  paas-mysql:\n    image: cap1573/mysql:5.6\n    environment:\n      MYSQL_ROOT_PASSWORD: 123456\n      container_name: paas-mysql\n    # \u6211\u4eec\u8fd9\u91cc\u6362\u4e2a\u7aef\u53e3\uff0c\u672c\u5730\u5df2\u7ecf\u67093306\u4e86\n    ports:\n      - "3308:3306"\n    # \u9700\u8981\u5c06\u91cd\u8981\u7684\u6570\u636e\u6302\u76d8\n    volumes:\n      - ./mysql:/var/lib/mysql\n  # \u6dfb\u52a0jaeger \u670d\u52a1\n  jaeger:\n    image: cap1573/jaeger\n    ports:\n      - "6831:6831/udp"\n      - "16686:16686"\n  # \u6dfb\u52a0\u7194\u65ad\u770b\u677f\n  hystrix-dasboard:\n    # \u955c\u50cf\u540d\u79f0\n    image: cap1573/hystrix-dashboard\n    ports:\n      - "9002:9002"\n')),(0,o.kt)("p",null,"\u7136\u540e\u91cd\u65b0\u542f\u52a8"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker-compose up\n")),(0,o.kt)("p",null,"\u770b\u677f\u8bbf\u95ee\u5730\u5740\uff1a",(0,o.kt)("a",{parentName:"p",href:"http://127.0.0.1:9002/hystrix"},"http://127.0.0.1:9002/hystrix")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"url\u4e00\u5b9a\u8981\u5e26\u4e0a",(0,o.kt)("inlineCode",{parentName:"strong"},"/hystrix")),"\uff0c\u4e0d\u7136\u8bbf\u95ee\u4e0d\u5230"),(0,o.kt)("h2",{id:"base\u670d\u52a1\u6dfb\u52a0\u7194\u65ad\u5668\u670d\u52a1"},"base\u670d\u52a1\u6dfb\u52a0\u7194\u65ad\u5668\u670d\u52a1"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"go get github.com/afex/hystrix-go/hystrix\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport (\n    "fmt"\n    "github.com/wujie/base/handler"\n    base "github.com/wujie/base/proto/base"\n    "github.com/wujie/common"\n    "github.com/afex/hystrix-go/hystrix"\n    "github.com/asim/go-micro/v3/registry"\n    "github.com/jinzhu/gorm"\n    "github.com/opentracing/opentracing-go"\n    "net"\n    "net/http"\n    //"github.com/afex/hystrix-go/hystrix"\n    "github.com/asim/go-micro/plugins/registry/consul/v3"\n    opentracing2 "github.com/asim/go-micro/plugins/wrapper/trace/opentracing/v3"\n    "github.com/asim/go-micro/v3"\n    _ "github.com/jinzhu/gorm/dialects/mysql"\n)\n\nfunc main() {\n    //\u9700\u8981\u672c\u5730\u542f\u52a8\uff0cmysql\uff0cconsul\u4e2d\u95f4\u4ef6\u670d\u52a1\n    //1.\u6ce8\u518c\u4e2d\u5fc3\n    //consul := consul.NewRegistry(func(options *registry.Options) {\n    //  options.Addrs = []string{\n    //      consulHost + ":" + strconv.FormatInt(consulPort, 10),\n    //  }\n    //})\n    consul := consul.NewRegistry(func(options *registry.Options) {\n        options.Addrs = []string{\n            "localhost:8500",\n        }\n    })\n    //2.\u914d\u7f6e\u4e2d\u5fc3\uff0c\u5b58\u653e\u7ecf\u5e38\u53d8\u52a8\u7684\u53d8\u91cf\n    consulConfig, err := common.GetConsulConfig("localhost", consulPort, "/micro/config")\n    if err != nil {\n        //common.Error(err)\n        fmt.Println(err)\n    }\n    fmt.Println(consulConfig)\n    //3.\u4f7f\u7528\u914d\u7f6e\u4e2d\u5fc3\u8fde\u63a5 mysql\n    // \u8fd9\u91cc\u7684path\u662f\u76f8\u5bf9\u4e8e /micro/config \u76ee\u5f55\u8def\u5f84\n    mysqlInfo := common.GetMysqlFromConsul(consulConfig, "mysql")\n    //\u521d\u59cb\u5316\u6570\u636e\u5e93\n    fmt.Println(mysqlInfo)\n    db, err := gorm.Open("mysql", mysqlInfo.User+":"+mysqlInfo.Pwd+"@("+mysqlInfo.Host+":3308)/"+mysqlInfo.Database+"?charset=utf8&parseTime=True&loc=Local")\n    if err != nil {\n        //\u547d\u4ee4\u884c\u8f93\u51fa\u4e0b\uff0c\u65b9\u4fbf\u67e5\u770b\u9519\u8bef\n        fmt.Println(err)\n        common.Fatal(err)\n        fmt.Println("mysql\u8fde\u63a5\u5931\u8d25")\n    }\n    fmt.Println("mysql\u8fde\u63a5\u6210\u529f")\n    defer db.Close()\n    //\u7981\u6b62\u590d\u8868\n    db.SingularTable(true)\n\n    //4.\u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a\n    //t, io, err := common.NewTracer("go.micro.service.base", tracerHost+":"+strconv.Itoa(tracerPort))\n    t, io, err := common.NewTracer("base", "localhost:6831")\n    if err != nil {\n        //common.Error(err)\n        fmt.Println(err)\n    }\n    defer io.Close()\n    // \u8bbe\u7f6e\u5168\u5c40\u53d8\u91cf\n    opentracing.SetGlobalTracer(t)\n\n    // 5. \u6dfb\u52a0\u7194\u65ad\u5668\uff0c\u4f5c\u4e3a\u5ba2\u6237\u7aef\u9700\u8981\u542f\u7528\n    hystrixStreamHandler := hystrix.NewStreamHandler()\n    // \u542f\u52a8\n    hystrixStreamHandler.Start()\n\n    //\u542f\u52a8\u76d1\u542c\u7a0b\u5e8f\n    go func() {\n        // \u9700\u8981\u4f7f\u7528\u5bf9\u5e94\u7684\u4e3b\u673aip\u4e0d\u7528127.0.0.1\n        //http://192.168.0.112:9092/turbine/turbine.stream\n        //\u770b\u677f\u8bbf\u95ee\u5730\u5740 http://127.0.0.1:9002/hystrix\uff0curl\u540e\u9762\u4e00\u5b9a\u8981\u5e26 /hystrix\n        err = http.ListenAndServe(net.JoinHostPort("0.0.0.0", "9092"), hystrixStreamHandler)\n        if err != nil {\n            // \u7b80\u5355\u5904\u7406error\n            fmt.Println(err)\n        }\n    }()\n\n    service := micro.NewService(\n        micro.Name("base-wj"),\n        micro.Version("latest"),\n        // \u6dfb\u52a0\u6ce8\u518c\u4e2d\u5fc3\n        micro.Registry(consul),\n        // \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a\n        micro.WrapHandler(opentracing2.NewHandlerWrapper(opentracing.GlobalTracer())),\n        // \u5ba2\u6237\u7aef\u7684\u65b9\u5f0f\n        micro.WrapClient(opentracing2.NewClientWrapper(opentracing.GlobalTracer())),\n    )\n\n    service.Init()\n\n    base.RegisterBaseHandler(service.Server(), new(handler.BaseHandler))\n\n    // \u542f\u52a8\u670d\u52a1\n    if err := service.Run(); err != nil {\n        //\u8f93\u51fa\u542f\u52a8\u5931\u8d25\u4fe1\u606f\n        common.Fatal(err)\n    }\n}\n\n')),(0,o.kt)("p",null,"\u628a\u7194\u65ad\u6ce8\u518c\u5230\u670d\u52a1\u4e2d\u53bb\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5355\u72ec\u5199\u4e00\u4e2a",(0,o.kt)("inlineCode",{parentName:"p"},"hystrix"),"\u7684\u63d2\u4ef6"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"go get github.com/asim/go-micro/v3/client\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"plugin/hystrix/hytrix.go")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package hystrix\n\nimport (\n    "context"\n    "fmt"\n    "github.com/afex/hystrix-go/hystrix"\n    "github.com/asim/go-micro/v3/client"\n)\n\ntype clientWrapper struct {\n    client.Client\n}\n\n// Call \u7194\u65ad\u903b\u8f91\nfunc (c *clientWrapper) Call(ctx context.Context, req client.Request, rsp interface{}, opts ...client.CallOption) error {\n    return hystrix.Do(req.Service()+"."+req.Endpoint(), func() error {\n        //\u6b63\u5e38\u6267\u884c\n        fmt.Println(req.Service() + "." + req.Endpoint())\n        return c.Client.Call(ctx, req, rsp, opts...)\n    }, func(e error) error {\n        //\u8d70\u7194\u65ad\u903b\u8f91,\u6bcf\u4e2a\u670d\u52a1\u90fd\u4e0d\u4e00\u6837\n        fmt.Println(req.Service() + "." + req.Endpoint() + "\u7684\u7194\u65ad\u903b\u8f91")\n        return e\n    })\n}\n\nfunc NewClientHystrixWrapper() client.Wrapper {\n    return func(i client.Client) client.Client {\n        return &clientWrapper{i}\n    }\n}\n\n')),(0,o.kt)("p",null,"\u670d\u52a1\u6dfb\u52a0\u4ee3\u7801"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'service := micro.NewService(\n        micro.Name("base-wj"),\n        micro.Version("latest"),\n        // \u6dfb\u52a0\u6ce8\u518c\u4e2d\u5fc3\n        micro.Registry(consul),\n        // \u6dfb\u52a0\u94fe\u8def\u8ffd\u8e2a\n        micro.WrapHandler(opentracing2.NewHandlerWrapper(opentracing.GlobalTracer())),\n        // \u5ba2\u6237\u7aef\u7684\u65b9\u5f0f\n        micro.WrapClient(opentracing2.NewClientWrapper(opentracing.GlobalTracer())),\n        // \u53ea\u4f5c\u4e3a\u5ba2\u6237\u7aef\u7684\u65f6\u5019\u8d77\u4f5c\u7528\n        micro.WrapClient(hystrix2.NewClientHystrixWrapper()),\n        // \u6dfb\u52a0\u9650\u6d41\n        micro.WrapHandler(ratelimit.NewHandlerWrapper(1000)),\n    )\n')))}p.isMDXComponent=!0}}]);